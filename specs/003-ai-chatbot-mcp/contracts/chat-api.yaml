openapi: 3.0.3
info:
  title: Chat API
  description: AI-powered chat endpoint for natural language task management
  version: 1.0.0
  contact:
    name: Hackathon II Todo App

servers:
  - url: http://localhost:8001
    description: Development server

security:
  - BearerAuth: []

paths:
  /api/chat:
    post:
      summary: Send chat message
      description: |
        Send a user message to the AI chatbot and receive an assistant response.
        The chatbot can create, list, update, complete, and delete tasks through
        natural language commands. User identity is derived from JWT token.
      operationId: sendChatMessage
      tags:
        - Chat
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              newConversation:
                summary: Start new conversation
                value:
                  message: "add a task to buy groceries tomorrow"
                  conversation_id: null
              existingConversation:
                summary: Continue conversation
                value:
                  message: "what are my tasks for today?"
                  conversation_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successful response with assistant message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                taskCreated:
                  summary: Task created successfully
                  value:
                    conversation_id: "550e8400-e29b-41d4-a716-446655440000"
                    message:
                      id: "660e8400-e29b-41d4-a716-446655440001"
                      role: "assistant"
                      content: "I've created a task 'buy groceries' with due date tomorrow."
                      created_at: "2026-01-15T10:30:00Z"
                    actions:
                      - type: "task_created"
                        task_id: 123
                taskList:
                  summary: Task list returned
                  value:
                    conversation_id: "550e8400-e29b-41d4-a716-446655440000"
                    message:
                      id: "660e8400-e29b-41d4-a716-446655440002"
                      role: "assistant"
                      content: "Here are your tasks for today:\n1. Buy groceries (due today)\n2. Finish report (due today)"
                      created_at: "2026-01-15T10:31:00Z"
                    actions:
                      - type: "tasks_listed"
                        task_ids: [123, 124]
        '401':
          description: Unauthorized - Invalid or missing JWT token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "unauthorized"
                message: "Invalid or missing authentication token"
        '500':
          description: Internal server error (AI service unavailable)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                conversation_id: "550e8400-e29b-41d4-a716-446655440000"
                message:
                  id: "660e8400-e29b-41d4-a716-446655440003"
                  role: "assistant"
                  content: "I'm having trouble connecting to my AI service right now. Please try again in a moment, or use the task list above to manage your tasks directly."
                  created_at: "2026-01-15T10:32:00Z"
                error: "ai_service_unavailable"

  /api/conversations:
    get:
      summary: List user's conversations
      description: Get list of user's recent conversations, ordered by last update
      operationId: listConversations
      tags:
        - Conversations
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of conversations to return
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationSummary'
              example:
                conversations:
                  - id: "550e8400-e29b-41d4-a716-446655440000"
                    title: "add a task to buy groceries tomorrow"
                    created_at: "2026-01-15T10:30:00Z"
                    updated_at: "2026-01-15T10:35:00Z"
                    message_count: 6
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/conversations/{conversation_id}/messages:
    get:
      summary: Get conversation messages
      description: Retrieve messages for a specific conversation with pagination
      operationId: getConversationMessages
      tags:
        - Conversations
      security:
        - BearerAuth: []
      parameters:
        - name: conversation_id
          in: path
          required: true
          description: Conversation UUID
          schema:
            type: string
            format: uuid
        - name: offset
          in: query
          description: Number of messages to skip
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: limit
          in: query
          description: Maximum number of messages to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                  total:
                    type: integer
                    description: Total number of messages in conversation
              example:
                messages:
                  - id: "660e8400-e29b-41d4-a716-446655440001"
                    role: "user"
                    content: "add a task to buy groceries tomorrow"
                    created_at: "2026-01-15T10:30:00Z"
                  - id: "660e8400-e29b-41d4-a716-446655440002"
                    role: "assistant"
                    content: "I've created a task 'buy groceries' with due date tomorrow."
                    created_at: "2026-01-15T10:30:05Z"
                total: 6
        '401':
          description: Unauthorized
        '404':
          description: Conversation not found or not owned by user

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Better Auth

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: User's natural language message
          minLength: 1
          maxLength: 2000
          example: "add a task to buy groceries tomorrow"
        conversation_id:
          type: string
          format: uuid
          nullable: true
          description: Existing conversation ID, or null to start new conversation
          example: "550e8400-e29b-41d4-a716-446655440000"

    ChatResponse:
      type: object
      required:
        - conversation_id
        - message
      properties:
        conversation_id:
          type: string
          format: uuid
          description: Conversation ID (new or existing)
          example: "550e8400-e29b-41d4-a716-446655440000"
        message:
          $ref: '#/components/schemas/Message'
        actions:
          type: array
          description: Actions performed by the assistant (e.g., task created)
          items:
            $ref: '#/components/schemas/Action'
        error:
          type: string
          nullable: true
          description: Error code if operation failed gracefully
          enum:
            - ai_service_unavailable
            - rate_limit_exceeded
            - database_error

    Message:
      type: object
      required:
        - id
        - role
        - content
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Message UUID
          example: "660e8400-e29b-41d4-a716-446655440001"
        role:
          type: string
          enum: [user, assistant]
          description: Message sender role
          example: "assistant"
        content:
          type: string
          description: Message text content
          example: "I've created a task 'buy groceries' with due date tomorrow."
        created_at:
          type: string
          format: date-time
          description: Message creation timestamp (ISO 8601)
          example: "2026-01-15T10:30:00Z"

    Action:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum:
            - task_created
            - task_updated
            - task_completed
            - task_deleted
            - tasks_listed
          description: Type of action performed
          example: "task_created"
        task_id:
          type: integer
          nullable: true
          description: Task ID for single task actions
          example: 123
        task_ids:
          type: array
          nullable: true
          description: Task IDs for list actions
          items:
            type: integer
          example: [123, 124, 125]

    ConversationSummary:
      type: object
      required:
        - id
        - title
        - created_at
        - updated_at
        - message_count
      properties:
        id:
          type: string
          format: uuid
          description: Conversation UUID
          example: "550e8400-e29b-41d4-a716-446655440000"
        title:
          type: string
          nullable: true
          description: Conversation title (from first message)
          example: "add a task to buy groceries tomorrow"
        created_at:
          type: string
          format: date-time
          description: Conversation creation timestamp
          example: "2026-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          description: Last message timestamp
          example: "2026-01-15T10:35:00Z"
        message_count:
          type: integer
          description: Total number of messages in conversation
          example: 6

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "unauthorized"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid or missing authentication token"
